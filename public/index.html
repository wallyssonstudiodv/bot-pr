<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>WhatsApp Bot - Painel</title>
<style>
body { font-family: Arial; background:#111; color:#0f0; text-align:center; }
img { max-width: 200px; margin: 10px; border:2px solid #0f0; }
table { margin:auto; border-collapse: collapse; width: 90%; margin-bottom:20px; }
td, th { border:1px solid #0f0; padding:5px; }
button { padding:5px 10px; cursor:pointer; background:#0f0; color:#000; border:none; }
input, select { padding:5px; margin:5px; background:#111; color:#0f0; border:1px solid #0f0; }
h1,h2 { margin-top:20px; }
</style>
</head>
<body>
<h1>WhatsApp Bot</h1>

<h2>QR Code</h2>
<img id="qr" src="" alt="QR Code"/>

<h2>Grupos Ativos</h2>
<div id="groups"></div>

<h2>Agendar Envio</h2>
<label>Data: <input type="date" id="date"></label>
<label>Hora: <input type="time" id="time"></label>
<button onclick="scheduleSend()">Agendar</button>

<h2>Agendamentos</h2>
<table id="scheduled">
<thead>
<tr><th>#</th><th>Data</th><th>Hora</th><th>Ação</th></tr>
</thead>
<tbody></tbody>
</table>

<h2>Histórico de Envios</h2>
<table id="history">
<thead>
<tr><th>Data</th><th>Grupos</th><th>Vídeo</th></tr>
</thead>
<tbody></tbody>
</table>

<script>
async function loadQRCode() {
    try {
        const qr = await fetch('qr.txt').then(r=>r.text());
        document.getElementById('qr').src = qr;
    } catch(e){ console.log('QR não disponível'); }
}

async function loadGroups() {
    const groups = await fetch('/groups').then(r=>r.json());
    const container = document.getElementById('groups'); container.innerHTML='';
    groups.forEach(g=>{
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=g.id; cb.id=g.id;
        const label = document.createElement('label'); label.htmlFor=g.id; label.textContent=g.name;
        container.appendChild(cb); container.appendChild(label);
        container.appendChild(document.createElement('br'));
    });
}

async function loadScheduled() {
    const data = await fetch('/scheduled').then(r=>r.json());
    const tbody = document.querySelector('#scheduled tbody'); tbody.innerHTML='';
    data.forEach((d,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${d.date}</td><td>${d.time}</td>
        <td><button onclick="deleteSchedule(${i})">Deletar</button></td>`;
        tbody.appendChild(tr);
    });
}

async function loadHistory() {
    const data = await fetch('/history').then(r=>r.json());
    const tbody = document.querySelector('#history tbody'); tbody.innerHTML='';
    data.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(d.date).toLocaleString()}</td>
        <td>${d.groups.join(', ')}</td>
        <td><a href="${d.video.link}" target="_blank">${d.video.title}</a></td>`;
        tbody.appendChild(tr);
    });
}

async function scheduleSend() {
    const groupIds = Array.from(document.querySelectorAll('#groups input:checked')).map(c=>c.value);
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    if (!groupIds.length) return alert('Selecione ao menos um grupo');
    await fetch('/schedule', {method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({groupIds, date, time})});
    loadScheduled();
}

async function deleteSchedule(index){
    await fetch('/scheduled/delete', {method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({index})});
    loadScheduled();
}

loadQRCode(); loadGroups(); loadScheduled(); loadHistory();
setInterval(loadQRCode, 10000);
setInterval(loadGroups, 10000);
setInterval(loadScheduled, 10000);
setInterval(loadHistory, 10000);
</script>
</body>
</html>