<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>WhatsApp Bot - Painel</title>
<style>
body { font-family: Arial; background:#111; color:#0f0; text-align:center; }
img { max-width: 200px; margin: 10px; }
table { margin:auto; border-collapse: collapse; width: 90%; }
td, th { border:1px solid #0f0; padding:5px; }
button { padding:5px 10px; cursor:pointer; }
</style>
</head>
<body>
<h1>WhatsApp Bot</h1>
<h2>QR Code</h2>
<img id="qr" src="" alt="QR Code"/>

<h2>Grupos Ativos</h2>
<div id="groups"></div>

<h2>Agendar Envio</h2>
<label>Data: <input type="date" id="date"></label>
<label>Hora: <input type="time" id="time"></label>
<label>Canal: <select id="channel"></select></label>
<button onclick="scheduleSend()">Agendar</button>

<h2>Agendamentos</h2>
<table id="scheduled"><thead><tr><th>#</th><th>Data</th><th>Hora</th><th>Canal</th><th>Ação</th></tr></thead><tbody></tbody></table>

<h2>Histórico</h2>
<table id="history"><thead><tr><th>Data</th><th>Grupos</th><th>Vídeo</th></tr></thead><tbody></tbody></table>

<script>
async function loadQRCode() {
    try { document.getElementById('qr').src = await fetch('qr.txt').then(r=>r.text()); } catch{}
}

async function loadGroups() {
    const groups = await fetch('/groups').then(r=>r.json());
    const container = document.getElementById('groups');
    container.innerHTML = '';
    groups.forEach(g=>{
        const cb = document.createElement('input'); cb.type='checkbox'; cb.value=g.id; cb.id=g.id;
        const label = document.createElement('label'); label.htmlFor=g.id; label.textContent=g.name;
        container.appendChild(cb); container.appendChild(label); container.appendChild(document.createElement('br'));
    });
}

async function loadScheduled() {
    const data = await fetch('/scheduled').then(r=>r.json());
    const tbody = document.querySelector('#scheduled tbody'); tbody.innerHTML='';
    data.forEach((d,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i+1}</td><td>${d.date}</td><td>${d.time}</td><td>${d.channelId}</td>
        <td><button onclick="deleteSchedule(${i})">Deletar</button></td>`;
        tbody.appendChild(tr);
    });
}

async function loadHistory() {
    const data = await fetch('/history').then(r=>r.json());
    const tbody = document.querySelector('#history tbody'); tbody.innerHTML='';
    data.forEach(d=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.date}</td><td>${d.groups.join(', ')}</td><td><a href="${d.video.link}" target="_blank">${d.video.title}</a></td>`;
        tbody.appendChild(tr);
    });
}

async function loadChannels() {
    const channels = [
        {id:"UCh-ceOeY4WVgS8R0onTaXmw", name:"Canal 1"},
        {id:"OUTRO_ID", name:"Canal 2"}
    ];
    const sel = document.getElementById('channel');
    channels.forEach(c=>{ const opt=document.createElement('option'); opt.value=c.id; opt.text=c.name; sel.appendChild(opt); });
}

async function scheduleSend() {
    const selected = Array.from(document.querySelectorAll('#groups input:checked')).map(i=>i.value);
    const date = document.getElementById('date').value;
    const time = document.getElementById('time').value;
    const channelId = document.getElementById('channel').value;
    if(!selected.length||!date||!time) return alert('Preencha tudo!');
    const res = await fetch('/schedule',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({groupIds:selected,date,time,channelId})}).then(r=>r.json());
    alert(res.message);
    loadScheduled();
}

async function deleteSchedule(index) {
    await fetch('/scheduled/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index})});
    loadScheduled();
}

loadQRCode();
loadGroups();
loadScheduled();
loadHistory();
loadChannels();
</script>
</body>
</html>